<style>
	input {
		width: 100%;
	}
	body {
	}
	.root {
		font-family: system-ui;
		font-size: 0.8em;
	}
	.list {
		width: 100%;
	}
	.list-item {
		padding: 2px;
	}
	.list-item-sel {
		background-color: cornflowerblue;
	}
</style>

<div class="root">
	<p>
		<input id="find_input" value="">
	</p>

	<div id="find_result" class="list">
		<div id="default_template" class="list-item">List Item</div>
		<div id="selected_template" class="list-item list-item-sel">Selected Item</div>
	</div>
</div>

<script>
	const inputElement = document.getElementById('find_input');
	const resultElement = document.getElementById('find_result');

	const defaultTemplate = document.getElementById("default_template");
	const selectedTemplate = document.getElementById("selected_template");
	clearResult();

	inputElement.oninput = () => {
		const text = String(inputElement.value).trim();
		parent.postMessage({pluginMessage: {type: 'on_input', text}}, '*')
	}

	inputElement.onkeydown = (event) => {
		// console.log(event.key);
		switch (event.key) {
			case "ArrowUp":
				setSelection(-1);
				break;
			case "ArrowDown":
				setSelection(+1);
				break;
			case "Enter":
				openPage();
				break;
			case "Escape":
				parent.postMessage({pluginMessage: {type: "on_close"}}, "*");
				break;
		}
	}

	onmessage = (event) => {
		const msg = event.data.pluginMessage;
		switch (msg.type)
		{
			case "search_result":
				updateResult(msg.nodes);
				break;
		}
	}

	let selectedIndex = 0;

	function setSelection(step)
	{
		const newIndex = selectedIndex + step;
		if (newIndex < 0 || newIndex >= resultElement.childNodes.length)
			return;

		let currentNode = resultElement.childNodes[selectedIndex];
		if (currentNode)
			currentNode.classList = defaultTemplate.classList;

		currentNode = resultElement.childNodes[newIndex];
		if (currentNode) {
			selectedIndex = newIndex;
			currentNode.classList = selectedTemplate.classList;
			// currentNode.scrollIntoView();
		}
	}

	function openPage()
	{
		const node = resultElement.childNodes[selectedIndex];
		const data = node["_data_"];
		parent.postMessage({pluginMessage: {type: "on_open", data}}, "*");
	}

	function updateResult(nodes)
	{
		while (resultElement.hasChildNodes()) {
			resultElement.removeChild(resultElement.lastChild);
		}

		selectedIndex = 0;

		for (let i = 0; i < nodes.length; i++) {
			const node = nodes[i];
			const item = defaultTemplate.cloneNode();
			item.innerText = node.name;
			item._data_ = node;
			if (i === selectedIndex)
				item.classList = selectedTemplate.classList;

			resultElement.appendChild(item);
		}
	}

	function clearResult()
	{
		while (resultElement.hasChildNodes()) {
			resultElement.removeChild(resultElement.lastChild);
		}
	}

	inputElement.focus();
</script>
