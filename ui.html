<style>
	::-webkit-scrollbar {
		width: 4px;
	}

	::-webkit-scrollbar-track {
		background: var(--figma-color-bg);
	}

	::-webkit-scrollbar-thumb {
		background: var(--figma-color-bg-secondary);
	}

	.icon--draft {
		background-image: url("data:image/svg+xml;charset=utf8,%3Csvg fill='none' height='32' width='32' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath clip-rule='evenodd' d='M10 8.5h7.707L22 12.793V23.5H10zm1 1v13h10v-9h-4v-4zm7 .707l2.293 2.293H18z' fill='%23000' fill-rule='evenodd'/%3E%3C/svg%3E");
	}

	.icon--instance {
		background-image: url("data:image/svg+xml;charset=utf8,%3Csvg fill='none' height='32' width='32' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath clip-rule='evenodd' d='M16 7l9 9-9 9-9-9zm-7.586 9L16 23.586 23.586 16 16 8.414z' fill='%23000' fill-rule='evenodd'/%3E%3C/svg%3E");
	}

	.icon--frame {
		background-image: url("data:image/svg+xml;charset=utf8,%3Csvg fill='none' height='32' width='32' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath clip-rule='evenodd' d='M11 24v-3H8v-1h3v-8H8v-1h3V8h1v3h8V8h1v3h3v1h-3v8h3v1h-3v3h-1v-3h-8v3zm9-4v-8h-8v8z' fill='%23000' fill-rule='evenodd'/%3E%3C/svg%3E");
	}

	.icon--component {
		background-image: url("data:image/svg+xml;charset=utf8,%3Csvg fill='none' height='32' width='32' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath clip-rule='evenodd' d='M12.063 10.938L16 14.874l3.938-3.938L16 7zm6.46 0L16 13.46l-2.523-2.524L16 8.415zm-6.46 10.124L16 25l3.938-3.938L16 17.125zm6.46 0L16 23.587l-2.523-2.523L16 18.538zM7 16l3.937-3.938L14.875 16l-3.938 3.938zm3.937 2.523L13.461 16l-2.524-2.523L8.415 16zM17.125 16l3.938 3.938L25 16l-3.938-3.938zm6.46 0l-2.523 2.523L18.54 16l2.523-2.523z' fill='%23000' fill-rule='evenodd'/%3E%3C/svg%3E");
	}

	input {
		background-color: var(--figma-color-bg-secondary);
		color: var(--figma-color-text);
		border: 1px solid var(--figma-color-border);
		min-height: 24px;
	}

	input:focus {
		outline: none;
	}

	.figma-dark input {
		color: var(--figma-color-text-secondary);
	}

	.root {
		font-family: system-ui;
		font-size: 0.8em;
	}

	.list-item {
		display: flex;
		flex-flow: row nowrap;
		padding: 2px;
		cursor: pointer;
		border: 1px solid transparent;
		color: var(--figma-color-text);
	}

	.list-header {
		padding: 4px 2px;
		cursor: pointer;
		color: var(--figma-color-text-tertiary);
		font-weight: bold;
	}

	.list-item:hover {
		border: 1px solid var(--figma-color-border);
		background-color: var(--figma-color-bg-hover);
	}

	.list-item-sel {
		background-color: var(--figma-color-bg-brand);
		color: var(--figma-color-text-onbrand);
	}

	.figma-dark .list-item {
		color: var(--figma-color-text-secondary);
	}

	.figma-dark .list-item-sel {
		color: var(--figma-color-text-onbrand);
	}

	.list {
		margin-top: 8px;
		overflow-y: auto;
	}

	.content {
		display: flex;
		flex-direction: column;
		align-items: stretch;
		width: 100%;
		height: 100%;
	}

	.icon {
		display: flex;
		align-items: center;
		justify-content: center;
		user-input: none;
		width: 16px;
		height: 16px;
		margin-right: 2px;
		user-select: none;
		background-position: 50% 50%;
	}

</style>

<div class="root">

	<div class="content">
		<input id="find_input" value="">
		<div id="find_result" class="list">

			<div id="default_template" class="list-item">
				<div class="icon icon--draft"></div>
				List Item
			</div>

			<div id="selected_template" class="list-item list-item-sel">Selected Item</div>

			<div id="header_template" class="list-header">Header</div>

		</div>
	</div>

</div>

<script>
	const inputElement = document.getElementById('find_input');
	const pagesElement = document.getElementById('find_result');

	const defaultTemplate = document.getElementById("default_template");
	const selectedTemplate = document.getElementById("selected_template");
	const headerTemplate = document.getElementById("header_template");

	let selectedIndex = 0;
	let listItems = [];

	function clearResult()
	{
		listItems = [];
		selectedIndex = -1;
		// while (pagesElement.hasChildNodes()) {
		// 	pagesElement.removeChild(pagesElement.lastChild);
		// }
	}

	clearResult();

	inputElement.oninput = () => {
		const text = String(inputElement.value).trim();
		parent.postMessage({pluginMessage: {type: 'on_input', text}}, '*')
	}

	inputElement.onkeydown = (event) => {
		// console.log(event.key);
		switch (event.key) {
			case "ArrowUp":
				setSelection(selectedIndex - 1, true);
				event.preventDefault();
				break;
			case "ArrowDown":
				setSelection(selectedIndex + 1, true);
				event.preventDefault();
				break;
			case "Enter":
				openPage();
				break;
			case "Escape":
				parent.postMessage({pluginMessage: {type: "on_close"}}, "*");
				break;
		}
	}

	onmessage = (event) => {
		const msg = event.data.pluginMessage;
		switch (msg.type)
		{
			case "search_result":
				updateResult(msg.data);
				break;
		}
	}

	function setSelection(newIndex, scroll)
	{
		if (newIndex < 0 || newIndex >= listItems.length)
			return;

		let currentNode = listItems[selectedIndex];
		if (currentNode)
			currentNode.classList = defaultTemplate.classList;

		currentNode = listItems[newIndex];
		if (currentNode) {
			selectedIndex = newIndex;
			currentNode.classList = selectedTemplate.classList;
		}

		if (scroll && currentNode)
			currentNode.scrollIntoView({block: "nearest"});
	}

	function openPage()
	{
		const node = listItems[selectedIndex];
		const data = node["_data_"];
		parent.postMessage({pluginMessage: {type: "on_open", data}}, "*");
	}

	function updateResult(data)
	{
		clearResult();

		addItems(data.recent, "recent");
		addItems(data.pages, "pages");
		addItems(data.layers, "layers");

		setSelection(0, false);
	}

	function addItems(data, title)
	{
		if (!data?.length)
			return;

		const header = headerTemplate.cloneNode(true);
		header.innerText = `${title.toUpperCase()}:`;
		pagesElement.appendChild(header);

		for (let i = 0; i < data.length; i++) {
			const nodeData = data[i];
			const node = defaultTemplate.cloneNode(true);
			node.lastChild.textContent = nodeData.name;
			node["_data_"] = nodeData;
			node.addEventListener("click", () => onItemClick(node));
			pagesElement.appendChild(node);
			listItems.push(node);
		}
	}

	function onItemClick(item)
	{
		const index = listItems.indexOf(item._data_);
		if (index < 0)
			return;
		setSelection(index);
		openPage();
	}

	inputElement.focus();
</script>
